
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Iscritti - Area Staff</title>
</head>
<body>
  <h1>Gestione Iscritti</h1>
  <form id="regForm" name="regForm">
    <input type="hidden" name="id">
    <fieldset>
      <legend>Bambino</legend>
      <label>Cognome e Nome<input name="bambino_nome"></label>
      <label>Luogo di Nascita<input name="bambino_luogo_nascita"></label>
      <label>Data di Nascita<input type="date" name="bambino_data_nascita"></label>
      <label>Codice Fiscale<input name="bambino_cf"></label>
      <label>Intolleranze<input name="intolleranze"></label>
      <label>Terapie<input name="terapie"></label>
      <label>Autorizzazione Foto<select name="privacy_foto"><option value="si">SÃ¬</option><option value="no">No</option></select></label>
    </fieldset>
    <fieldset>
      <legend>Genitore</legend>
      <label>Cognome e Nome<input name="genitore_nome"></label>
      <label>Luogo di Nascita<input name="genitore_luogo_nascita"></label>
      <label>Data di Nascita<input type="date" name="genitore_data_nascita"></label>
      <label>Codice Fiscale<input name="genitore_cf"></label>
      <label>Residenza<input name="genitore_res"></label>
      <label>Email<input type="email" name="email"></label>
      <label>Telefono<input name="telefono"></label>
    </fieldset>
    <button type="submit">Salva iscrizione</button>
  </form>

  <script>
  const key = 'campIscritti';
  const uid = () => 'id_' + Date.now();
  const getList = () => JSON.parse(localStorage.getItem(key) || '[]');
  const saveList = l => localStorage.setItem(key, JSON.stringify(l));
  let editing = null;

  function render() {
    console.log("Render chiamato");
  }

  document.forms['regForm'].addEventListener('submit', async e => {
    e.preventDefault();
    const f = e.target;
    const data = Object.fromEntries(new FormData(f).entries());
    const list = getList();

    if (editing !== null) {
      data.id = list[editing].id;
      list[editing] = data;
      editing = null;
    } else {
      data.id = uid();
      list.push(data);
    }

    // Salva in localStorage
    saveList(list);

    // Invia a Google Sheets
    const toSend = new FormData();
    toSend.append("foglio", "Iscrizioni_Staff");
    toSend.append("bambino_nome", data.bambino_nome);
    toSend.append("bambino_luogo_nascita", data.bambino_luogo_nascita);
    toSend.append("bambino_data_nascita", data.bambino_data_nascita);
    toSend.append("bambino_cf", data.bambino_cf);
    toSend.append("intolleranze", data.intolleranze);
    toSend.append("terapie", data.terapie);
    toSend.append("privacy_foto", data.privacy_foto);
    toSend.append("genitore_nome", data.genitore_nome);
    toSend.append("genitore_luogo_nascita", data.genitore_luogo_nascita);
    toSend.append("genitore_data_nascita", data.genitore_data_nascita);
    toSend.append("genitore_cf", data.genitore_cf);
    toSend.append("genitore_res", data.genitore_res);
    toSend.append("email", data.email);
    toSend.append("telefono", data.telefono);

    await fetch("https://script.google.com/macros/s/AKfycbyX9pB4Z-z5N7ElRCLFZnQuB30nrrReLjwcnXOvZnuxccOAgN5ZURK4tnKr56hn9iKbXQ/exec", {
      method: "POST",
      body: toSend
    });

    alert("Iscrizione salvata!");
    f.reset();
    render();
  });
  </script>
</body>
</html>
